<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مدیریت اقساط تعاونی فرهنگیان پرسنل کارخانجات استیل البرز و خرم صنعت</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- کتابخانه تاریخ شمسی -->
    <script src="https://cdn.jsdelivr.net/npm/jalali-moment/dist/jalali-moment.browser.js"></script>
    <style>
        * {
            font-family: 'Tahoma', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px 30px;
            text-align: center;
            border-bottom: 5px solid #3498db;
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        header h1 i {
            color: #3498db;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background-color: #2c3e50;
            overflow: hidden;
        }
        
        .tab-button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 18px 25px;
            font-size: 16px;
            color: white;
            transition: 0.3s;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .tab-button:hover {
            background-color: #34495e;
        }
        
        .tab-button.active {
            background-color: #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tab-content.active {
            display: block;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f8ff;
        }
        
        .input-form {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #3498db;
        }
        
        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #7f8c8d;
            border-top: 1px solid #eee;
        }
        
        .delete-btn {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px 10px;
        }
        
        .paid {
            color: #27ae60;
            font-weight: bold;
        }
        
        .unpaid {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .debts-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            padding: 10px;
        }
        
        .debt-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        
        .debt-item:hover {
            background: #e9ecef;
        }
        
        .debt-item.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        @media (max-width: 768px) {
            .tab-button {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .stat-card {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> داشبورد مدیریت اقساط تعاونی فرهنگیان پرسنل کارخانجات استیل البرز و خرم صنعت</h1>
            <p class="subtitle">امور کارکنان صنایع استیل البرز - نسخه آنلاین با Google Sheets</p>
            <div style="margin-top: 10px; font-size: 14px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 3px; display: inline-block;">
                <i class="fas fa-cloud"></i> وضعیت: <span id="connectionStatus">در حال اتصال...</span>
            </div>
        </header>
        
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'customers')">
                <i class="fas fa-users"></i> مشتریان
            </button>
            <button class="tab-button" onclick="openTab(event, 'debts')">
                <i class="fas fa-file-invoice-dollar"></i> ثبت بدهی
            </button>
            <button class="tab-button" onclick="openTab(event, 'payments')">
                <i class="fas fa-money-check-alt"></i> پرداخت قسط
            </button>
            <button class="tab-button" onclick="openTab(event, 'dashboard')">
                <i class="fas fa-tachometer-alt"></i> داشبورد
            </button>
            <button class="tab-button" onclick="openTab(event, 'sync')">
                <i class="fas fa-sync-alt"></i> همگام‌سازی
            </button>
        </div>
        
        <!-- تب مشتریان -->
        <div id="customers" class="tab-content active">
            <h2><i class="fas fa-users"></i> مدیریت اطلاعات مشتریان</h2>
            
            <div class="input-form">
                <h3>افزودن مشتری جدید</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="employeeCode">کد پرسنلی</label>
                        <input type="number" id="employeeCode" placeholder="مثال: 1001">
                    </div>
                    <div class="form-group">
                        <label for="firstName">نام</label>
                        <input type="text" id="firstName" placeholder="مثال: علی">
                    </div>
                    <div class="form-group">
                        <label for="lastName">نام خانوادگی</label>
                        <input type="text" id="lastName" placeholder="مثال: رضایی">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nationalCode">کد ملی</label>
                        <input type="text" id="nationalCode" placeholder="مثال: 0012345678">
                    </div>
                    <div class="form-group">
                        <label for="hireDate">تاریخ استخدام (شمسی)</label>
                        <input type="text" id="hireDate" placeholder="1400/01/01">
                    </div>
                    <div class="form-group">
                        <label for="status">وضعیت</label>
                        <select id="status">
                            <option value="فعال">فعال</option>
                            <option value="غیرفعال">غیرفعال</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addCustomer()">
                    <i class="fas fa-user-plus"></i> افزودن مشتری (آنلاین + آفلاین)
                </button>
                <button class="btn" onclick="syncCustomers()">
                    <i class="fas fa-sync"></i> همگام‌سازی با Google Sheets
                </button>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchCustomer" placeholder="جستجوی مشتری بر اساس نام، کد پرسنلی یا کد ملی...">
                <button class="btn" onclick="searchCustomers()">
                    <i class="fas fa-search"></i> جستجو
                </button>
                <button class="btn btn-warning" onclick="clearSearch()">
                    <i class="fas fa-times"></i> پاک کردن
                </button>
            </div>
            
            <table id="customersTable">
                <thead>
                    <tr>
                        <th>کد پرسنلی</th>
                        <th>نام</th>
                        <th>نام خانوادگی</th>
                        <th>کد ملی</th>
                        <th>تاریخ استخدام</th>
                        <th>وضعیت</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody id="customersTableBody">
                    <!-- داده‌ها به صورت پویا اضافه می‌شوند -->
                </tbody>
            </table>
            
            <div class="actions">
                <button class="btn" onclick="exportToCSV('customers')">
                    <i class="fas fa-file-export"></i> خروجی Excel (CSV)
                </button>
                <button class="btn btn-danger" onclick="clearAllCustomers()">
                    <i class="fas fa-trash-alt"></i> حذف همه مشتریان (محلی)
                </button>
            </div>
        </div>
        
        <!-- تب ثبت بدهی -->
        <div id="debts" class="tab-content">
            <h2><i class="fas fa-file-invoice-dollar"></i> ثبت بدهی و اقساط</h2>
            
            <div class="input-form">
                <h3>ثبت بدهی جدید</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="debtEmployeeCode">کد پرسنلی مشتری</label>
                        <input type="number" id="debtEmployeeCode" placeholder="کد پرسنلی را وارد کنید">
                        <button class="btn" style="margin-top: 5px; width: 100%;" onclick="findCustomerByCode()">
                            <i class="fas fa-search"></i> پیدا کردن مشتری
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="debtCustomerName">نام و نام خانوادگی</label>
                        <input type="text" id="debtCustomerName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="debtAmount">مبلغ کل بدهی (ریال)</label>
                        <input type="number" id="debtAmount" placeholder="مثال: 10000000">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="installmentCount">تعداد اقساط</label>
                        <select id="installmentCount">
                            <option value="1">1 قسط</option>
                            <option value="2">2 قسط</option>
                            <option value="3">3 قسط</option>
                            <option value="4">4 قسط</option>
                            <option value="5">5 قسط</option>
                            <option value="6">6 قسط</option>
                            <option value="7">7 قسط</option>
                            <option value="8">8 قسط</option>
                            <option value="9">9 قسط</option>
                            <option value="10">10 قسط</option>
                            <option value="11">11 قسط</option>
                            <option value="12">12 قسط</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="installmentAmount">مبلغ هر قسط (ریال)</label>
                        <input type="number" id="installmentAmount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="debtDate">تاریخ ثبت (شمسی)</label>
                        <input type="text" id="debtDate" placeholder="1402/10/15">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addDebt()">
                    <i class="fas fa-save"></i> ثبت بدهی (آنلاین + آفلاین)
                </button>
                <button class="btn" onclick="calculateInstallment()">
                    <i class="fas fa-calculator"></i> محاسبه اقساط
                </button>
            </div>
            
            <table id="debtsTable">
                <thead>
                    <tr>
                        <th>شماره سند</th>
                        <th>کد پرسنلی</th>
                        <th>نام مشتری</th>
                        <th>مبلغ کل</th>
                        <th>تعداد اقساط</th>
                        <th>مبلغ هر قسط</th>
                        <th>تاریخ ثبت</th>
                        <th>وضعیت</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody id="debtsTableBody">
                    <!-- داده‌ها به صورت پویا اضافه می‌شوند -->
                </tbody>
            </table>
            
            <div class="actions">
                <button class="btn" onclick="exportToCSV('debts')">
                    <i class="fas fa-file-export"></i> خروجی Excel (CSV)
                </button>
            </div>
        </div>
        
        <!-- تب پرداخت قسط -->
        <div id="payments" class="tab-content">
            <h2><i class="fas fa-money-check-alt"></i> ثبت پرداخت قسط</h2>
            
            <div class="input-form">
                <h3>ثبت پرداخت جدید</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentEmployeeCode">کد پرسنلی</label>
                        <input type="number" id="paymentEmployeeCode" placeholder="کد پرسنلی را وارد کنید">
                        <button class="btn" style="margin-top: 5px; width: 100%;" onclick="findCustomerForPayment()">
                            <i class="fas fa-search"></i> پیدا کردن مشتری
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="paymentCustomerName">نام و نام خانوادگی</label>
                        <input type="text" id="paymentCustomerName" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>بدهی‌های مشتری</label>
                        <div id="customerDebtsList" class="debts-list">
                            <!-- لیست بدهی‌ها به صورت پویا نمایش داده می‌شود -->
                        </div>
                        <input type="hidden" id="selectedDebtId">
                    </div>
                    <div class="form-group">
                        <label for="paymentAmount">مبلغ پرداختی (ریال)</label>
                        <input type="number" id="paymentAmount" placeholder="مبلغ را وارد کنید">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="installmentNumber">شماره قسط</label>
                        <input type="number" id="installmentNumber" placeholder="مثال: 1">
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">تاریخ پرداخت (شمسی)</label>
                        <input type="text" id="paymentDate" placeholder="1402/10/15">
                    </div>
                    <div class="form-group">
                        <label for="paymentMonth">ماه پرداخت</label>
                        <select id="paymentMonth">
                            <option value="فروردین">فروردین</option>
                            <option value="اردیبهشت">اردیبهشت</option>
                            <option value="خرداد">خرداد</option>
                            <option value="تیر">تیر</option>
                            <option value="مرداد">مرداد</option>
                            <option value="شهریور">شهریور</option>
                            <option value="مهر">مهر</option>
                            <option value="آبان">آبان</option>
                            <option value="آذر">آذر</option>
                            <option value="دی">دی</option>
                            <option value="بهمن">بهمن</option>
                            <option value="اسفند">اسفند</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentYear">سال پرداخت</label>
                        <input type="number" id="paymentYear" placeholder="1402" value="1402">
                    </div>
                    <div class="form-group">
                        <label for="paymentDescription">توضیحات</label>
                        <input type="text" id="paymentDescription" placeholder="توضیحات پرداخت">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addPayment()">
                    <i class="fas fa-money-bill-wave"></i> ثبت پرداخت (آنلاین + آفلاین)
                </button>
            </div>
            
            <table id="paymentsTable">
                <thead>
                    <tr>
                        <th>شماره پرداخت</th>
                        <th>کد پرسنلی</th>
                        <th>نام مشتری</th>
                        <th>شماره سند</th>
                        <th>مبلغ پرداختی</th>
                        <th>شماره قسط</th>
                        <th>تاریخ پرداخت</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody id="paymentsTableBody">
                    <!-- داده‌ها به صورت پویا اضافه می‌شوند -->
                </tbody>
            </table>
            
            <div class="actions">
                <button class="btn" onclick="exportToCSV('payments')">
                    <i class="fas fa-file-export"></i> خروجی Excel (CSV)
                </button>
            </div>
        </div>
        
        <!-- تب داشبورد -->
        <div id="dashboard" class="tab-content">
            <h2><i class="fas fa-tachometer-alt"></i> داشبورد آماری</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <h3>تعداد مشتریان فعال</h3>
                    <div class="stat-value" id="activeCustomers">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>مجموع بدهی‌های جاری</h3>
                    <div class="stat-value" id="totalDebts">0 ریال</div>
                </div>
                
                <div class="stat-card">
                    <h3>مجموع پرداختی‌ها</h3>
                    <div class="stat-value" id="totalPayments">0 ریال</div>
                </div>
                
                <div class="stat-card">
                    <h3>بدهی‌های معوق</h3>
                    <div class="stat-value" id="overdueDebts">0 مورد</div>
                </div>
            </div>
            
            <h3>جستجوی وضعیت بدهی مشتری</h3>
            <div class="search-box">
                <input type="number" id="dashboardEmployeeCode" placeholder="کد پرسنلی مشتری را وارد کنید">
                <button class="btn" onclick="searchCustomerDebts()">
                    <i class="fas fa-search"></i> جستجو
                </button>
            </div>
            
            <div id="customerDebtResult" style="margin-top: 20px;">
                <!-- نتایج جستجو نمایش داده می‌شود -->
            </div>
            
            <h3 style="margin-top: 30px;">گزارش پرداخت‌های ماه جاری</h3>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="reportMonth">ماه</label>
                    <select id="reportMonth">
                        <option value="فروردین">فروردین</option>
                        <option value="اردیبهشت">اردیبهشت</option>
                        <option value="خرداد">خرداد</option>
                        <option value="تیر">تیر</option>
                        <option value="مرداد">مرداد</option>
                        <option value="شهریور">شهریور</option>
                        <option value="مهر">مهر</option>
                        <option value="آبان">آبان</option>
                        <option value="آذر">آذر</option>
                        <option value="دی">دی</option>
                        <option value="بهمن">بهمن</option>
                        <option value="اسفند">اسفند</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportYear">سال</label>
                    <input type="number" id="reportYear" value="1402">
                </div>
                <div class="form-group">
                    <label style="visibility: hidden;">.</label>
                    <button class="btn" onclick="generateMonthlyReport()">
                        <i class="fas fa-chart-bar"></i> ایجاد گزارش
                    </button>
                </div>
            </div>
            
            <table id="monthlyReportTable">
                <thead>
                    <tr>
                        <th>کد پرسنلی</th>
                        <th>نام مشتری</th>
                        <th>شماره سند</th>
                        <th>مبلغ پرداختی</th>
                        <th>شماره قسط</th>
                        <th>تاریخ پرداخت</th>
                    </tr>
                </thead>
                <tbody id="monthlyReportTableBody">
                    <!-- گزارش ماهانه نمایش داده می‌شود -->
                </tbody>
            </table>
        </div>
        
        <!-- تب همگام‌سازی -->
        <div id="sync" class="tab-content">
            <h2><i class="fas fa-sync-alt"></i> مدیریت همگام‌سازی با Google Sheets</h2>
            
            <div class="input-form">
                <h3>تنظیمات اتصال</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>آدرس API شما:</label>
                        <input type="text" value="https://script.google.com/macros/s/AKfycbwRYQFZknKbcgSBOJtkWlHI7NOA6paRLTPrnWAeV_MhX4A6ElrtIChQMuratsLoNa2W/exec" readonly style="background: #f0f0f0;">
                        <small>این API به Google Sheets شما متصل است</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>وضعیت اتصال:</label>
                        <div id="apiStatus" style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-top: 5px;">
                            <i class="fas fa-circle-notch fa-spin"></i> در حال بررسی...
                        </div>
                    </div>
                    <div class="form-group">
                        <label>تاریخ آخرین همگام‌سازی:</label>
                        <div id="lastSync" style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-top: 5px;">
                            هنوز همگام‌سازی نشده است
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="testConnection()">
                        <i class="fas fa-wifi"></i> تست اتصال به API
                    </button>
                    <button class="btn" onclick="syncAllDataSmart()">
                        <i class="fas fa-sync-alt"></i> همگام‌سازی هوشمند
                    </button>
                    <button class="btn btn-warning" onclick="downloadFullBackup()">
                        <i class="fas fa-download"></i> دانلود پشتیبان کامل
                    </button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <h3>داده‌های محلی</h3>
                    <div class="stat-value" id="localCustomers">0</div>
                    <small>مشتریان در مرورگر</small>
                </div>
                
                <div class="stat-card">
                    <h3>داده‌های آنلاین</h3>
                    <div class="stat-value" id="onlineCustomers">0</div>
                    <small>مشتریان در Google Sheets</small>
                </div>
                
                <div class="stat-card">
                    <h3>رکوردهای ارسال شده</h3>
                    <div class="stat-value" id="sentRecords">0</div>
                    <small>به Google Sheets</small>
                </div>
                
                <div class="stat-card">
                    <h3>حجم داده</h3>
                    <div class="stat-value" id="dataSize">0 KB</div>
                    <small>کل داده‌ها</small>
                </div>
            </div>
            
            <h3>کنترل‌های پیشرفته</h3>
            <div class="input-form">
                <div class="actions">
                    <button class="btn" onclick="uploadNewToSheets()">
                        <i class="fas fa-cloud-upload-alt"></i> آپلود داده‌های جدید
                    </button>
                    <button class="btn" onclick="downloadFromSheets()">
                        <i class="fas fa-cloud-download-alt"></i> دانلود از Google Sheets
                    </button>
                    <button class="btn btn-danger" onclick="resetSyncStatus()">
                        <i class="fas fa-redo"></i> ریست وضعیت همگام‌سازی
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-right: 4px solid #3498db;">
                    <h4><i class="fas fa-info-circle"></i> راهنمای همگام‌سازی:</h4>
                    <ul style="margin-top: 10px; padding-right: 20px;">
                        <li><strong>همگام‌سازی هوشمند:</strong> فقط داده‌های جدید ارسال می‌شوند</li>
                        <li><strong>آپلود داده‌های جدید:</strong> فقط داده‌هایی که هنوز ارسال نشده‌اند</li>
                        <li><strong>ریست وضعیت:</strong> اگر مشکل تکراری شدن داشتید</li>
                        <li><strong>پشتیبان‌گیری:</strong> همیشه پشتیبان بگیرید</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>طراحی توسط استاد اعظم امیرعباس چهرازی | نسخه آنلاین با Google Sheets</p>
            <p>داده‌ها در Google Sheets و مرورگر شما ذخیره می‌شوند</p>
            <div style="margin-top: 10px;">
                <button class="btn" onclick="backupData()">
                    <i class="fas fa-download"></i> پشتیبان‌گیری از داده‌ها
                </button>
                <button class="btn btn-warning" onclick="restoreData()">
                    <i class="fas fa-upload"></i> بازیابی داده‌ها
                </button>
                <button class="btn" onclick="openGoogleSheets()">
                    <i class="fab fa-google"></i> باز کردن Google Sheets
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== تنظیمات API ====================
        const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbwRYQFZknKbcgSBOJtkWlHI7NOA6paRLTPrnWAeV_MhX4A6ElrtIChQMuratsLoNa2W/exec';
        
        // ==================== داده‌های اولیه ====================
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let debts = JSON.parse(localStorage.getItem('debts')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];
        
        // ==================== سیستم جلوگیری از تکراری شدن ====================
        
        // نگهداری رکوردهایی که قبلاً به Sheets ارسال شده‌اند
        let sentToSheets = {
            customers: new Set(JSON.parse(localStorage.getItem('sentCustomers')) || []),
            debts: new Set(JSON.parse(localStorage.getItem('sentDebts')) || []),
            payments: new Set(JSON.parse(localStorage.getItem('sentPayments')) || [])
        };
        
        // ذخیره وضعیت همگام‌سازی
        function saveSyncStatus() {
            localStorage.setItem('sentCustomers', JSON.stringify([...sentToSheets.customers]));
            localStorage.setItem('sentDebts', JSON.stringify([...sentToSheets.debts]));
            localStorage.setItem('sentPayments', JSON.stringify([...sentToSheets.payments]));
        }
        
        // ==================== توابع اصلی ====================
        
        // ذخیره داده‌ها در localStorage
        function saveDataToLocal() {
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('debts', JSON.stringify(debts));
            localStorage.setItem('payments', JSON.stringify(payments));
            updateDashboardStats();
            updateSyncStats();
        }
        
        // ذخیره در Google Sheets (فقط داده‌های جدید)
        async function saveNewToGoogleSheets() {
            try {
                let sentCount = 0;
                
                // ارسال مشتریان جدید
                for (const customer of customers) {
                    const customerId = customer.employee_code || customer.id;
                    
                    if (!sentToSheets.customers.has(customerId)) {
                        await fetch(GOOGLE_SHEETS_API, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'add',
                                type: 'customers',
                                data: customer
                            })
                        });
                        
                        sentToSheets.customers.add(customerId);
                        sentCount++;
                    }
                }
                
                // ارسال بدهی‌های جدید
                for (const debt of debts) {
                    const debtId = debt.id;
                    
                    if (!sentToSheets.debts.has(debtId)) {
                        await fetch(GOOGLE_SHEETS_API, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'add',
                                type: 'debts',
                                data: debt
                            })
                        });
                        
                        sentToSheets.debts.add(debtId);
                        sentCount++;
                    }
                }
                
                // ارسال پرداخت‌های جدید
                for (const payment of payments) {
                    const paymentId = payment.id;
                    
                    if (!sentToSheets.payments.has(paymentId)) {
                        await fetch(GOOGLE_SHEETS_API, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'add',
                                type: 'payments',
                                data: payment
                            })
                        });
                        
                        sentToSheets.payments.add(paymentId);
                        sentCount++;
                    }
                }
                
                // ذخیره وضعیت همگام‌سازی
                saveSyncStatus();
                localStorage.setItem('lastSync', new Date().toLocaleString('fa-IR'));
                
                return { success: true, sentCount };
            } catch (error) {
                console.error('خطا در ذخیره Google Sheets:', error);
                return { success: false, error: error.message };
            }
        }
        
        // بارگذاری از Google Sheets (بدون تکراری شدن)
        async function loadFromGoogleSheetsSmart(type) {
            try {
                const response = await fetch(`${GOOGLE_SHEETS_API}?action=getAll&type=${type}&t=${Date.now()}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        return result.data || [];
                    }
                }
                return [];
            } catch (error) {
                console.log(`خطا در خواندن ${type} از Google Sheets:`, error);
                return [];
            }
        }
        
        // تابع هوشمند برای افزودن رکورد (هم به localStorage هم به Sheets)
        async function addRecordSmart(record, type) {
            let recordId;
            
            // اضافه کردن به آرایه محلی
            if (type === 'customers') {
                recordId = record.employee_code;
                customers.push(record);
            } else if (type === 'debts') {
                recordId = record.id;
                debts.push(record);
            } else if (type === 'payments') {
                recordId = record.id;
                payments.push(record);
            }
            
            // ذخیره در localStorage
            saveDataToLocal();
            
            // تلاش برای ارسال به Google Sheets
            let onlineSaved = false;
            if (navigator.onLine && !sentToSheets[type].has(recordId)) {
                try {
                    await fetch(GOOGLE_SHEETS_API, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            action: 'add',
                            type: type,
                            data: record
                        })
                    });
                    
                    sentToSheets[type].add(recordId);
                    saveSyncStatus();
                    localStorage.setItem('lastSync', new Date().toLocaleString('fa-IR'));
                    onlineSaved = true;
                } catch (error) {
                    console.log(`ذخیره ${type} آنلاین ناموفق بود`);
                }
            }
            
            return { localSaved: true, onlineSaved };
        }
        
        // بارگذاری اولیه
        document.addEventListener('DOMContentLoaded', async function() {
            // تنظیم تاریخ امروز شمسی
            const today = moment().format('jYYYY/jMM/jDD');
            document.getElementById('hireDate').value = today;
            document.getElementById('debtDate').value = today;
            document.getElementById('paymentDate').value = today;
            
            // تنظیم سال جاری شمسی
            const currentYear = moment().format('jYYYY');
            document.getElementById('paymentYear').value = currentYear;
            document.getElementById('reportYear').value = currentYear;
            
            // بارگذاری داده‌های محلی
            loadCustomers();
            loadDebts();
            loadPayments();
            updateDashboardStats();
            updateSyncStats();
            
            // تست اتصال به API
            testConnection();
            
            // تنظیم رویداد تغییر برای محاسبه اقساط
            document.getElementById('debtAmount').addEventListener('input', calculateInstallment);
            document.getElementById('installmentCount').addEventListener('change', calculateInstallment);
            
            // رویداد جستجوی مشتری
            document.getElementById('searchCustomer').addEventListener('input', function() {
                if (this.value === '') {
                    loadCustomers();
                }
            });
        });
        
        // ==================== مدیریت تب‌ها ====================
        function openTab(evt, tabName) {
            const tabcontents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontents.length; i++) {
                tabcontents[i].classList.remove("active");
            }
            
            const tabbuttons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            if (tabName === 'dashboard') {
                updateDashboardStats();
            } else if (tabName === 'sync') {
                updateSyncStats();
                testConnection();
            }
        }
        
        // ==================== توابع مشتریان ====================
        function loadCustomers() {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.employee_code || customer.id}</td>
                    <td>${customer.first_name || customer.firstName}</td>
                    <td>${customer.last_name || customer.lastName}</td>
                    <td>${customer.national_code || customer.nationalCode}</td>
                    <td>${customer.hire_date || customer.hireDate}</td>
                    <td>${customer.status}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteCustomer(${customer.employee_code || customer.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function addCustomer() {
            const employeeCode = parseInt(document.getElementById('employeeCode').value);
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const nationalCode = document.getElementById('nationalCode').value.trim();
            const hireDate = document.getElementById('hireDate').value.trim();
            const status = document.getElementById('status').value;
            
            if (!employeeCode || !firstName || !lastName || !nationalCode || !hireDate) {
                showMessage('لطفاً تمام فیلدهای ضروری را پر کنید', 'error');
                return;
            }
            
            // بررسی تکراری نبودن کد پرسنلی
            if (customers.some(c => (c.employee_code || c.id) === employeeCode)) {
                showMessage('کد پرسنلی تکراری است', 'error');
                return;
            }
            
            // اعتبارسنجی تاریخ شمسی
            if (!isValidJalaliDate(hireDate)) {
                showMessage('تاریخ استخدام معتبر نیست. لطفاً تاریخ را به فرمت شمسی وارد کنید (مثال: 1400/01/01)', 'error');
                return;
            }
            
            const newCustomer = {
                employee_code: employeeCode,
                first_name: firstName,
                last_name: lastName,
                national_code: nationalCode,
                hire_date: hireDate,
                status: status,
                created_at: new Date().toISOString()
            };
            
            // استفاده از تابع هوشمند برای افزودن
            const result = await addRecordSmart(newCustomer, 'customers');
            
            // بارگذاری مجدد و نمایش پیغام
            loadCustomers();
            updateDashboardStats();
            updateSyncStats();
            
            // پاک کردن فرم
            document.getElementById('employeeCode').value = '';
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('nationalCode').value = '';
            document.getElementById('hireDate').value = moment().format('jYYYY/jMM/jDD');
            
            if (result.onlineSaved) {
                showMessage('✅ مشتری با موفقیت اضافه شد (آنلاین + آفلاین)', 'success');
            } else {
                showMessage('⚠ مشتری به صورت آفلاین ذخیره شد (در اولین فرصت آنلاین همگام می‌شود)', 'warning');
            }
        }
        
        async function deleteCustomer(id) {
            if (!confirm('آیا از حذف این مشتری مطمئن هستید؟')) {
                return;
            }
            
            // حذف از آرایه محلی
            customers = customers.filter(c => (c.employee_code || c.id) !== id);
            
            // حذف از لیست ارسال شده‌ها
            sentToSheets.customers.delete(id);
            
            // حذف بدهی‌ها و پرداخت‌های مربوطه
            const customerDebts = debts.filter(d => d.employee_code === id);
            customerDebts.forEach(debt => {
                payments = payments.filter(p => p.debt_id !== debt.id);
                sentToSheets.debts.delete(debt.id);
            });
            debts = debts.filter(d => d.employee_code !== id);
            
            // ذخیره تغییرات
            saveDataToLocal();
            saveSyncStatus();
            
            // بارگذاری مجدد
            loadCustomers();
            loadDebts();
            loadPayments();
            updateDashboardStats();
            updateSyncStats();
            
            showMessage('مشتری با موفقیت حذف شد', 'success');
        }
        
        function searchCustomers() {
            const query = document.getElementById('searchCustomer').value.toLowerCase().trim();
            if (!query) {
                loadCustomers();
                return;
            }
            
            const filtered = customers.filter(c => 
                (c.employee_code || c.id).toString().includes(query) ||
                (c.first_name || c.firstName).toLowerCase().includes(query) ||
                (c.last_name || c.lastName).toLowerCase().includes(query) ||
                (c.national_code || c.nationalCode).includes(query)
            );
            
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            
            filtered.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.employee_code || customer.id}</td>
                    <td>${customer.first_name || customer.firstName}</td>
                    <td>${customer.last_name || customer.lastName}</td>
                    <td>${customer.national_code || customer.nationalCode}</td>
                    <td>${customer.hire_date || customer.hireDate}</td>
                    <td>${customer.status}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteCustomer(${customer.employee_code || customer.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function clearSearch() {
            document.getElementById('searchCustomer').value = '';
            loadCustomers();
        }
        
        async function clearAllCustomers() {
            if (!confirm('آیا از حذف تمام مشتریان مطمئن هستید؟ این عمل قابل برگشت نیست.')) {
                return;
            }
            
            customers = [];
            debts = [];
            payments = [];
            sentToSheets.customers.clear();
            sentToSheets.debts.clear();
            sentToSheets.payments.clear();
            
            saveDataToLocal();
            saveSyncStatus();
            
            loadCustomers();
            loadDebts();
            loadPayments();
            updateDashboardStats();
            updateSyncStats();
            
            showMessage('همه داده‌ها حذف شدند', 'success');
        }
        
        async function syncCustomers() {
            showMessage('🔄 در حال همگام‌سازی مشتریان با Google Sheets...', 'info');
            
            try {
                // خواندن از Google Sheets
                const onlineCustomers = await loadFromGoogleSheetsSmart('customers');
                
                if (onlineCustomers.length > 0) {
                    let addedCount = 0;
                    
                    // اضافه کردن فقط مشتریان جدید
                    onlineCustomers.forEach(online => {
                        const customerId = online.employee_code || online.id;
                        const exists = customers.some(local => 
                            (local.employee_code || local.id) === customerId
                        );
                        
                        if (!exists) {
                            customers.push(online);
                            // علامت گذاری که از Sheets آمده (نیازی به ارسال مجدد نیست)
                            sentToSheets.customers.add(customerId);
                            addedCount++;
                        }
                    });
                    
                    // ذخیره
                    saveDataToLocal();
                    saveSyncStatus();
                    loadCustomers();
                    updateSyncStats();
                    
                    if (addedCount > 0) {
                        showMessage(`✅ ${addedCount} مشتری جدید از Google Sheets اضافه شد`, 'success');
                    } else {
                        showMessage('هیچ مشتری جدیدی در Google Sheets یافت نشد', 'info');
                    }
                } else {
                    showMessage('هیچ مشتری در Google Sheets یافت نشد', 'info');
                }
            } catch (error) {
                showMessage('❌ خطا در همگام‌سازی مشتریان', 'error');
            }
        }
        
        // ==================== توابع بدهی‌ها ====================
        function loadDebts() {
            const tbody = document.getElementById('debtsTableBody');
            tbody.innerHTML = '';
            
            debts.forEach(debt => {
                // محاسبه مبلغ پرداخت شده
                const paid = payments.filter(p => p.debt_id === debt.id)
                    .reduce((sum, p) => sum + p.amount, 0);
                
                // تعیین وضعیت
                let status = debt.status;
                if (paid >= debt.amount) {
                    status = "تسویه شده";
                } else if (paid > 0) {
                    status = "در حال پرداخت";
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${debt.id}</td>
                    <td>${debt.employee_code}</td>
                    <td>${debt.customer_name}</td>
                    <td>${formatCurrency(debt.amount)}</td>
                    <td>${debt.installments}</td>
                    <td>${formatCurrency(debt.installment_amount)}</td>
                    <td>${debt.date}</td>
                    <td class="${status === 'تسویه شده' ? 'paid' : 'unpaid'}">${status}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteDebt(${debt.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function findCustomerByCode() {
            const code = parseInt(document.getElementById('debtEmployeeCode').value);
            if (!code) {
                showMessage('لطفاً کد پرسنلی را وارد کنید', 'error');
                return;
            }
            
            const customer = customers.find(c => (c.employee_code || c.id) === code);
            if (customer) {
                document.getElementById('debtCustomerName').value = `${customer.first_name || customer.firstName} ${customer.last_name || customer.lastName}`;
                calculateInstallment();
            } else {
                showMessage('مشتری با این کد پرسنلی یافت نشد', 'error');
                document.getElementById('debtCustomerName').value = '';
            }
        }
        
        function calculateInstallment() {
            const amount = parseInt(document.getElementById('debtAmount').value) || 0;
            const installments = parseInt(document.getElementById('installmentCount').value) || 1;
            
            if (amount > 0 && installments > 0) {
                const installmentAmount = Math.round(amount / installments);
                document.getElementById('installmentAmount').value = installmentAmount;
            }
        }
        
        async function addDebt() {
            const employeeCode = parseInt(document.getElementById('debtEmployeeCode').value);
            const customerName = document.getElementById('debtCustomerName').value.trim();
            const amount = parseInt(document.getElementById('debtAmount').value);
            const installments = parseInt(document.getElementById('installmentCount').value);
            const installmentAmount = parseInt(document.getElementById('installmentAmount').value);
            const date = document.getElementById('debtDate').value.trim();
            
            if (!employeeCode || !customerName || !amount || !installments || !date) {
                showMessage('لطفاً تمام فیلدهای ضروری را پر کنید', 'error');
                return;
            }
            
            // بررسی وجود مشتری
            const customer = customers.find(c => (c.employee_code || c.id) === employeeCode);
            if (!customer) {
                showMessage('مشتری با این کد پرسنلی وجود ندارد', 'error');
                return;
            }
            
            // اعتبارسنجی تاریخ شمسی
            if (!isValidJalaliDate(date)) {
                showMessage('تاریخ ثبت معتبر نیست. لطفاً تاریخ را به فرمت شمسی وارد کنید (مثال: 1402/10/15)', 'error');
                return;
            }
            
            // تولید شماره سند جدید
            const newId = debts.length > 0 ? Math.max(...debts.map(d => d.id)) + 1 : 5001;
            
            const newDebt = {
                id: newId,
                employee_code: employeeCode,
                customer_name: customerName,
                amount: amount,
                installments: installments,
                installment_amount: installmentAmount,
                date: date,
                status: "جاری",
                paid_amount: 0,
                created_at: new Date().toISOString()
            };
            
            // استفاده از تابع هوشمند برای افزودن
            const result = await addRecordSmart(newDebt, 'debts');
            
            // بارگذاری مجدد
            loadDebts();
            updateDashboardStats();
            updateSyncStats();
            
            // پاک کردن فرم
            document.getElementById('debtEmployeeCode').value = '';
            document.getElementById('debtCustomerName').value = '';
            document.getElementById('debtAmount').value = '';
            document.getElementById('installmentAmount').value = '';
            document.getElementById('debtDate').value = moment().format('jYYYY/jMM/jDD');
            
            if (result.onlineSaved) {
                showMessage('✅ بدهی با موفقیت ثبت شد (آنلاین + آفلاین)', 'success');
            } else {
                showMessage('⚠ بدهی به صورت آفلاین ثبت شد (در اولین فرصت آنلاین همگام می‌شود)', 'warning');
            }
        }
        
        async function deleteDebt(id) {
            if (!confirm('آیا از حذف این بدهی مطمئن هستید؟')) {
                return;
            }
            
            debts = debts.filter(d => d.id !== id);
            sentToSheets.debts.delete(id);
            payments = payments.filter(p => p.debt_id !== id);
            
            saveDataToLocal();
            saveSyncStatus();
            
            loadDebts();
            loadPayments();
            updateDashboardStats();
            updateSyncStats();
            
            showMessage('بدهی با موفقیت حذف شد', 'success');
        }
        
        // ==================== توابع پرداخت‌ها ====================
        function loadPayments() {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';
            
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.id}</td>
                    <td>${payment.employee_code}</td>
                    <td>${payment.customer_name}</td>
                    <td>${payment.debt_id}</td>
                    <td>${formatCurrency(payment.amount)}</td>
                    <td>${payment.installment_number}</td>
                    <td>${payment.date}</td>
                    <td>
                        <button class="delete-btn" onclick="deletePayment(${payment.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function findCustomerForPayment() {
            const employeeCode = parseInt(document.getElementById('paymentEmployeeCode').value);
            if (!employeeCode) {
                showMessage('لطفاً کد پرسنلی را وارد کنید', 'error');
                return;
            }
            
            const customer = customers.find(c => (c.employee_code || c.id) === employeeCode);
            if (!customer) {
                showMessage('مشتری با این کد پرسنلی یافت نشد', 'error');
                document.getElementById('paymentCustomerName').value = '';
                document.getElementById('customerDebtsList').innerHTML = '';
                document.getElementById('selectedDebtId').value = '';
                return;
            }
            
            document.getElementById('paymentCustomerName').value = `${customer.first_name || customer.firstName} ${customer.last_name || customer.lastName}`;
            
            // نمایش بدهی‌های مشتری
            const customerDebts = debts.filter(d => d.employee_code === employeeCode);
            const debtsList = document.getElementById('customerDebtsList');
            debtsList.innerHTML = '';
            
            if (customerDebts.length === 0) {
                debtsList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">این مشتری هیچ بدهی فعالی ندارد</div>';
                document.getElementById('selectedDebtId').value = '';
                return;
            }
            
            customerDebts.forEach(debt => {
                const paid = payments.filter(p => p.debt_id === debt.id)
                    .reduce((sum, p) => sum + p.amount, 0);
                const remaining = debt.amount - paid;
                const paidInstallments = payments.filter(p => p.debt_id === debt.id).length;
                
                const debtItem = document.createElement('div');
                debtItem.className = 'debt-item';
                debtItem.innerHTML = `
                    <strong>سند ${debt.id}</strong><br>
                    مبلغ کل: ${formatCurrency(debt.amount)}<br>
                    قسط: ${paidInstallments}/${debt.installments}<br>
                    مانده: ${formatCurrency(remaining)}
                `;
                
                debtItem.onclick = function() {
                    document.querySelectorAll('.debt-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    this.classList.add('selected');
                    document.getElementById('selectedDebtId').value = debt.id;
                    
                    const nextInstallment = paidInstallments + 1;
                    document.getElementById('installmentNumber').value = nextInstallment;
                    document.getElementById('paymentAmount').value = debt.installment_amount;
                };
                
                debtsList.appendChild(debtItem);
            });
            
            if (customerDebts.length > 0) {
                debtsList.firstChild.click();
            }
        }
        
        async function addPayment() {
            const employeeCode = parseInt(document.getElementById('paymentEmployeeCode').value);
            const customerName = document.getElementById('paymentCustomerName').value.trim();
            const debtId = parseInt(document.getElementById('selectedDebtId').value);
            const amount = parseInt(document.getElementById('paymentAmount').value);
            const installmentNumber = parseInt(document.getElementById('installmentNumber').value);
            const date = document.getElementById('paymentDate').value.trim();
            const month = document.getElementById('paymentMonth').value;
            const year = document.getElementById('paymentYear').value;
            const description = document.getElementById('paymentDescription').value.trim();
            
            if (!employeeCode || !customerName || !debtId || !amount || !installmentNumber || !date) {
                showMessage('لطفاً تمام فیلدهای ضروری را پر کنید و یک بدهی را انتخاب نمایید', 'error');
                return;
            }
            
            const debt = debts.find(d => d.id === debtId);
            if (!debt) {
                showMessage('بدهی انتخاب شده وجود ندارد', 'error');
                return;
            }
            
            if (!isValidJalaliDate(date)) {
                showMessage('تاریخ پرداخت معتبر نیست. لطفاً تاریخ را به فرمت شمسی وارد کنید (مثال: 1402/10/15)', 'error');
                return;
            }
            
            // بررسی اینکه آیا این پرداخت خاص قبلاً ثبت شده
            const existingPayment = payments.find(p => p.debt_id === debtId && p.installment_number === installmentNumber);
            if (existingPayment) {
                if (!confirm(`قسط شماره ${installmentNumber} قبلاً ثبت شده است. آیا می‌خواهید آن را بازنویسی کنید؟`)) {
                    return;
                }
                // حذف پرداخت قبلی از لیست ارسال شده‌ها
                sentToSheets.payments.delete(existingPayment.id);
                payments = payments.filter(p => !(p.debt_id === debtId && p.installment_number === installmentNumber));
            }
            
            const newId = payments.length > 0 ? Math.max(...payments.map(p => p.id)) + 1 : 8001;
            
            const newPayment = {
                id: newId,
                debt_id: debtId,
                employee_code: employeeCode,
                customer_name: customerName,
                amount: amount,
                installment_number: installmentNumber,
                date: date,
                month: month,
                year: year,
                description: description || `قسط شماره ${installmentNumber}`,
                created_at: new Date().toISOString()
            };
            
            // استفاده از تابع هوشمند برای افزودن
            const result = await addRecordSmart(newPayment, 'payments');
            
            loadPayments();
            loadDebts();
            updateDashboardStats();
            updateSyncStats();
            
            document.getElementById('paymentEmployeeCode').value = '';
            document.getElementById('paymentCustomerName').value = '';
            document.getElementById('customerDebtsList').innerHTML = '';
            document.getElementById('selectedDebtId').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('installmentNumber').value = '';
            document.getElementById('paymentDate').value = moment().format('jYYYY/jMM/jDD');
            document.getElementById('paymentDescription').value = '';
            
            if (result.onlineSaved) {
                showMessage('✅ پرداخت با موفقیت ثبت شد (آنلاین + آفلاین)', 'success');
            } else {
                showMessage('⚠ پرداخت به صورت آفلاین ثبت شد (در اولین فرصت آنلاین همگام می‌شود)', 'warning');
            }
        }
        
        async function deletePayment(id) {
            if (!confirm('آیا از حذف این پرداخت مطمئن هستید؟')) {
                return;
            }
            
            payments = payments.filter(p => p.id !== id);
            sentToSheets.payments.delete(id);
            
            saveDataToLocal();
            saveSyncStatus();
            
            loadPayments();
            loadDebts();
            updateDashboardStats();
            updateSyncStats();
            
            showMessage('پرداخت با موفقیت حذف شد', 'success');
        }
        
        // ==================== توابع داشبورد ====================
        function updateDashboardStats() {
            const activeCustomersCount = customers.filter(c => c.status === 'فعال').length;
            document.getElementById('activeCustomers').textContent = activeCustomersCount;
            
            const totalDebtsAmount = debts
                .filter(d => {
                    const paid = payments.filter(p => p.debt_id === d.id)
                        .reduce((sum, p) => sum + p.amount, 0);
                    return paid < d.amount;
                })
                .reduce((sum, d) => sum + d.amount, 0);
            document.getElementById('totalDebts').textContent = formatCurrency(totalDebtsAmount);
            
            const totalPaymentsAmount = payments.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('totalPayments').textContent = formatCurrency(totalPaymentsAmount);
            
            let overdueCount = 0;
            const currentDate = moment();
            
            debts.forEach(debt => {
                const paid = payments.filter(p => p.debt_id === debt.id)
                    .reduce((sum, p) => sum + p.amount, 0);
                
                if (paid < debt.amount) {
                    const debtDate = moment(debt.date, 'jYYYY/jMM/jDD');
                    const monthsSinceDebt = currentDate.diff(debtDate, 'jMonth');
                    
                    if (monthsSinceDebt >= debt.installments) {
                        overdueCount++;
                    }
                }
            });
            
            document.getElementById('overdueDebts').textContent = overdueCount + ' مورد';
        }
        
        function searchCustomerDebts() {
            const code = parseInt(document.getElementById('dashboardEmployeeCode').value);
            if (!code) {
                showMessage('لطفاً کد پرسنلی را وارد کنید', 'error');
                return;
            }
            
            const customer = customers.find(c => (c.employee_code || c.id) === code);
            if (!customer) {
                document.getElementById('customerDebtResult').innerHTML = 
                    '<div style="color: red; padding: 15px; background: #ffe6e6; border-radius: 5px;">مشتری با این کد پرسنلی یافت نشد</div>';
                return;
            }
            
            const customerDebts = debts.filter(d => d.employee_code === code);
            const customerPayments = payments.filter(p => p.employee_code === code);
            
            let html = `<div style="background: #f8f9fa; padding: 20px; border-radius: 5px;">
                <h4>وضعیت بدهی‌های ${customer.first_name || customer.firstName} ${customer.last_name || customer.lastName}</h4>`;
            
            if (customerDebts.length === 0) {
                html += '<p>این مشتری هیچ بدهی ثبت شده‌ای ندارد.</p>';
            } else {
                let totalDebt = 0;
                let totalPaid = 0;
                
                customerDebts.forEach(debt => {
                    const paid = payments.filter(p => p.debt_id === debt.id)
                        .reduce((sum, p) => sum + p.amount, 0);
                    const remaining = debt.amount - paid;
                    const paidInstallments = payments.filter(p => p.debt_id === debt.id).length;
                    
                    totalDebt += debt.amount;
                    totalPaid += paid;
                    
                    html += `
                        <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 5px; border-right: 5px solid ${remaining > 0 ? '#e74c3c' : '#27ae60'}">
                            <strong>سند شماره ${debt.id}:</strong> ${formatCurrency(debt.amount)}<br>
                            <strong>تاریخ ثبت:</strong> ${debt.date}<br>
                            <strong>تعداد اقساط:</strong> ${debt.installments} قسط<br>
                            <strong>اقساط پرداخت شده:</strong> ${paidInstallments} از ${debt.installments}<br>
                            <strong>مبلغ پرداخت شده:</strong> ${formatCurrency(paid)}<br>
                            <strong>مانده بدهی:</strong> ${formatCurrency(remaining)}<br>
                            <strong>وضعیت:</strong> ${remaining > 0 ? 'در حال پرداخت' : 'تسویه شده'}
                        </div>
                    `;
                });
                
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #2c3e50; color: white; border-radius: 5px;">
                        <strong>جمع کل بدهی‌ها:</strong> ${formatCurrency(totalDebt)}<br>
                        <strong>جمع کل پرداختی‌ها:</strong> ${formatCurrency(totalPaid)}<br>
                        <strong>مانده کل:</strong> ${formatCurrency(totalDebt - totalPaid)}
                    </div>
                `;
            }
            
            html += `</div>`;
            document.getElementById('customerDebtResult').innerHTML = html;
        }
        
        function generateMonthlyReport() {
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportYear').value;
            
            const monthlyPayments = payments.filter(p => p.month === month && p.year.toString() === year.toString());
            
            const tbody = document.getElementById('monthlyReportTableBody');
            tbody.innerHTML = '';
            
            if (monthlyPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #7f8c8d;">
                            هیچ پرداختی برای ${month} ${year} ثبت نشده است
                        </td>
                    </tr>
                `;
                return;
            }
            
            monthlyPayments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.employee_code}</td>
                    <td>${payment.customer_name}</td>
                    <td>${payment.debt_id}</td>
                    <td>${formatCurrency(payment.amount)}</td>
                    <td>${payment.installment_number}</td>
                    <td>${payment.date}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ==================== توابع همگام‌سازی ====================
        async function testConnection() {
            const statusDiv = document.getElementById('apiStatus');
            const connectionStatus = document.getElementById('connectionStatus');
            
            statusDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> در حال تست اتصال...';
            connectionStatus.textContent = 'در حال تست اتصال...';
            
            try {
                const response = await fetch(GOOGLE_SHEETS_API);
                
                if (response.ok) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #27ae60;"></i> اتصال برقرار است - API فعال';
                    connectionStatus.textContent = 'آنلاین';
                    connectionStatus.style.color = '#27ae60';
                    
                    // آپدیت آخرین همگام‌سازی
                    const lastSync = localStorage.getItem('lastSync') || 'هنوز همگام‌سازی نشده است';
                    document.getElementById('lastSync').textContent = lastSync;
                    
                    return true;
                } else {
                    throw new Error('پاسخ سرور معتبر نیست');
                }
            } catch (error) {
                statusDiv.innerHTML = '<i class="fas fa-times-circle" style="color: #e74c3c;"></i> اتصال برقرار نیست - حالت آفلاین';
                connectionStatus.textContent = 'آفلاین';
                connectionStatus.style.color = '#e74c3c';
                return false;
            }
        }
        
        // همگام‌سازی هوشمند
        async function syncAllDataSmart() {
            showMessage('🔄 در حال همگام‌سازی هوشمند...', 'info');
            
            try {
                // 1. آپلود داده‌های جدید به Sheets
                const uploadResult = await saveNewToGoogleSheets();
                
                // 2. دانلود از Sheets
                const [onlineCustomers, onlineDebts, onlinePayments] = await Promise.all([
                    loadFromGoogleSheetsSmart('customers'),
                    loadFromGoogleSheetsSmart('debts'),
                    loadFromGoogleSheetsSmart('payments')
                ]);
                
                let addedCount = 0;
                
                // اضافه کردن مشتریان جدید
                onlineCustomers.forEach(online => {
                    const customerId = online.employee_code || online.id;
                    const exists = customers.some(local => 
                        (local.employee_code || local.id) === customerId
                    );
                    
                    if (!exists) {
                        customers.push(online);
                        sentToSheets.customers.add(customerId);
                        addedCount++;
                    }
                });
                
                // اضافه کردن بدهی‌های جدید
                onlineDebts.forEach(online => {
                    const exists = debts.some(local => local.id === online.id);
                    
                    if (!exists) {
                        debts.push(online);
                        sentToSheets.debts.add(online.id);
                        addedCount++;
                    }
                });
                
                // اضافه کردن پرداخت‌های جدید
                onlinePayments.forEach(online => {
                    const exists = payments.some(local => local.id === online.id);
                    
                    if (!exists) {
                        payments.push(online);
                        sentToSheets.payments.add(online.id);
                        addedCount++;
                    }
                });
                
                // ذخیره همه تغییرات
                saveDataToLocal();
                saveSyncStatus();
                
                // آپدیت نمایش
                loadCustomers();
                loadDebts();
                loadPayments();
                updateDashboardStats();
                updateSyncStats();
                
                const totalSent = uploadResult.sentCount || 0;
                
                if (totalSent > 0 || addedCount > 0) {
                    showMessage(`✅ همگام‌سازی کامل: ${totalSent} رکورد ارسال شد، ${addedCount} رکورد دریافت شد`, 'success');
                } else {
                    showMessage('✅ همه داده‌ها همگام هستند - هیچ تغییر جدیدی وجود نداشت', 'success');
                }
                
                return true;
            } catch (error) {
                showMessage('❌ خطا در همگام‌سازی هوشمند', 'error');
                return false;
            }
        }
        
        function updateSyncStats() {
            // آمار داده‌های محلی
            document.getElementById('localCustomers').textContent = customers.length;
            
            // آمار رکوردهای ارسال شده
            const totalSent = sentToSheets.customers.size + sentToSheets.debts.size + sentToSheets.payments.size;
            document.getElementById('sentRecords').textContent = totalSent;
            
            // آمار حجم داده
            const customersSize = JSON.stringify(customers).length;
            const debtsSize = JSON.stringify(debts).length;
            const paymentsSize = JSON.stringify(payments).length;
            const totalSize = customersSize + debtsSize + paymentsSize;
            const totalSizeKB = (totalSize / 1024).toFixed(2);
            document.getElementById('dataSize').textContent = `${totalSizeKB} KB`;
            
            // آمار آنلاین (تخمینی)
            document.getElementById('onlineCustomers').textContent = sentToSheets.customers.size;
            
            // وضعیت همگام‌سازی
            const lastSync = localStorage.getItem('lastSync');
            if (lastSync) {
                document.getElementById('syncStatus').textContent = 'همگام شده';
                document.getElementById('syncStatus').style.color = '#27ae60';
            } else {
                document.getElementById('syncStatus').textContent = 'همگام نشده';
                document.getElementById('syncStatus').style.color = '#e74c3c';
            }
            
            // آپدیت وضعیت اتصال
            if (navigator.onLine) {
                document.getElementById('connectionStatus').textContent = 'آنلاین';
                document.getElementById('connectionStatus').style.color = '#27ae60';
            } else {
                document.getElementById('connectionStatus').textContent = 'آفلاین';
                document.getElementById('connectionStatus').style.color = '#e74c3c';
            }
        }
        
        // آپلود فقط داده‌های جدید
        async function uploadNewToSheets() {
            showMessage('🔼 در حال آپلود داده‌های جدید به Google Sheets...', 'info');
            
            try {
                const result = await saveNewToGoogleSheets();
                
                if (result.success) {
                    if (result.sentCount > 0) {
                        showMessage(`✅ ${result.sentCount} رکورد جدید به Google Sheets آپلود شد`, 'success');
                    } else {
                        showMessage('✅ همه داده‌ها قبلاً آپلود شده بودند', 'info');
                    }
                    localStorage.setItem('lastSync', new Date().toLocaleString('fa-IR'));
                    updateSyncStats();
                } else {
                    showMessage('❌ خطا در آپلود داده‌ها به Google Sheets', 'error');
                }
            } catch (error) {
                showMessage('❌ خطا در آپلود داده‌ها', 'error');
            }
        }
        
        async function downloadFromSheets() {
            if (!confirm('آیا می‌خواهید همه داده‌ها را از Google Sheets دانلود کنید؟ داده‌های تکراری اضافه نمی‌شوند.')) {
                return;
            }
            
            showMessage('🔽 در حال دانلود از Google Sheets...', 'info');
            
            try {
                const [onlineCustomers, onlineDebts, onlinePayments] = await Promise.all([
                    loadFromGoogleSheetsSmart('customers'),
                    loadFromGoogleSheetsSmart('debts'),
                    loadFromGoogleSheetsSmart('payments')
                ]);
                
                let addedCount = 0;
                
                // اضافه کردن فقط داده‌های جدید
                onlineCustomers.forEach(online => {
                    const customerId = online.employee_code || online.id;
                    if (!customers.some(c => (c.employee_code || c.id) === customerId)) {
                        customers.push(online);
                        sentToSheets.customers.add(customerId);
                        addedCount++;
                    }
                });
                
                onlineDebts.forEach(online => {
                    if (!debts.some(d => d.id === online.id)) {
                        debts.push(online);
                        sentToSheets.debts.add(online.id);
                        addedCount++;
                    }
                });
                
                onlinePayments.forEach(online => {
                    if (!payments.some(p => p.id === online.id)) {
                        payments.push(online);
                        sentToSheets.payments.add(online.id);
                        addedCount++;
                    }
                });
                
                saveDataToLocal();
                saveSyncStatus();
                
                loadCustomers();
                loadDebts();
                loadPayments();
                updateDashboardStats();
                updateSyncStats();
                
                if (addedCount > 0) {
                    showMessage(`✅ ${addedCount} رکورد جدید از Google Sheets دانلود شد`, 'success');
                } else {
                    showMessage('✅ همه داده‌ها قبلاً دانلود شده بودند', 'info');
                }
            } catch (error) {
                showMessage('❌ خطا در دانلود از Google Sheets', 'error');
            }
        }
        
        // ریست وضعیت همگام‌سازی
        function resetSyncStatus() {
            if (!confirm('آیا مطمئن هستید می‌خواهید وضعیت همگام‌سازی را ریست کنید؟ این کار باعث می‌شود دفعه بعد همه داده‌ها دوباره ارسال شوند.')) {
                return;
            }
            
            sentToSheets.customers.clear();
            sentToSheets.debts.clear();
            sentToSheets.payments.clear();
            
            saveSyncStatus();
            updateSyncStats();
            
            showMessage('✅ وضعیت همگام‌سازی ریست شد. در همگام‌سازی بعدی، داده‌های جدید شناسایی و ارسال می‌شوند.', 'success');
        }
        
        function downloadFullBackup() {
            const allData = {
                customers: customers,
                debts: debts,
                payments: payments,
                sentCustomers: [...sentToSheets.customers],
                sentDebts: [...sentToSheets.debts],
                sentPayments: [...sentToSheets.payments],
                lastSync: localStorage.getItem('lastSync'),
                backupDate: new Date().toLocaleString('fa-IR'),
                totalRecords: customers.length + debts.length + payments.length
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `پشتیبان_کامل_مدیریت_اقساط_${new Date().toLocaleDateString('fa-IR')}.json`;
            
            link.click();
            
            showMessage('✅ پشتیبان کامل با موفقیت دانلود شد', 'success');
        }
        
        function openGoogleSheets() {
            window.open('https://docs.google.com/spreadsheets/', '_blank');
        }
        
        // ==================== توابع کمکی ====================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fa-IR').format(amount) + ' ریال';
        }
        
        function isValidJalaliDate(dateStr) {
            if (!dateStr) return false;
            const regex = /^[0-9]{4}\/[0-9]{1,2}\/[0-9]{1,2}$/;
            if (!regex.test(dateStr)) return false;
            const m = moment(dateStr, 'jYYYY/jMM/jDD');
            return m.isValid();
        }
        
        function showMessage(text, type = 'info') {
            // حذف پیغام قبلی
            const oldMsg = document.getElementById('globalMessage');
            if (oldMsg) oldMsg.remove();
            
            // رنگ‌ها
            const colors = {
                success: '#27ae60',
                warning: '#f39c12',
                error: '#e74c3c',
                info: '#3498db'
            };
            
            // ایجاد پیغام
            const msg = document.createElement('div');
            msg.id = 'globalMessage';
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 15px 25px;
                border-radius: 5px;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                font-family: Tahoma;
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;
            
            const icons = {
                success: 'fa-check-circle',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times-circle',
                info: 'fa-info-circle'
            };
            
            msg.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                ${text}
                <button onclick="this.parentElement.remove()" style="
                    background: none;
                    border: none;
                    color: white;
                    margin-right: 15px;
                    cursor: pointer;
                ">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(msg);
            
            // حذف خودکار
            setTimeout(() => {
                if (msg.parentElement) {
                    msg.style.opacity = '0';
                    msg.style.transition = 'opacity 0.3s';
                    setTimeout(() => msg.remove(), 300);
                }
            }, 5000);
        }
        
        function exportToCSV(type) {
            let data, headers, filename;
            
            switch(type) {
                case 'customers':
                    data = customers;
                    headers = ['کد پرسنلی', 'نام', 'نام خانوادگی', 'کد ملی', 'تاریخ استخدام', 'وضعیت'];
                    filename = 'مشتریان.csv';
                    break;
                    
                case 'debts':
                    data = debts.map(debt => {
                        const paid = payments.filter(p => p.debt_id === debt.id)
                            .reduce((sum, p) => sum + p.amount, 0);
                        const remaining = debt.amount - paid;
                        const paidInstallments = payments.filter(p => p.debt_id === debt.id).length;
                        
                        return {
                            'شماره سند': debt.id,
                            'کد پرسنلی': debt.employee_code,
                            'نام مشتری': debt.customer_name,
                            'مبلغ کل': debt.amount,
                            'تعداد اقساط': debt.installments,
                            'مبلغ هر قسط': debt.installment_amount,
                            'تاریخ ثبت': debt.date,
                            'اقساط پرداخت شده': paidInstallments,
                            'مبلغ پرداخت شده': paid,
                            'مانده بدهی': remaining,
                            'وضعیت': remaining > 0 ? 'در حال پرداخت' : 'تسویه شده'
                        };
                    });
                    headers = ['شماره سند', 'کد پرسنلی', 'نام مشتری', 'مبلغ کل', 'تعداد اقساط', 'مبلغ هر قسط', 'تاریخ ثبت', 'اقساط پرداخت شده', 'مبلغ پرداخت شده', 'مانده بدهی', 'وضعیت'];
                    filename = 'بدهی‌ها.csv';
                    break;
                    
                case 'payments':
                    data = payments.map(payment => ({
                        'شماره پرداخت': payment.id,
                        'کد پرسنلی': payment.employee_code,
                        'نام مشتری': payment.customer_name,
                        'شماره سند': payment.debt_id,
                        'مبلغ پرداختی': payment.amount,
                        'شماره قسط': payment.installment_number,
                        'تاریخ پرداخت': payment.date,
                        'ماه': payment.month,
                        'سال': payment.year,
                        'توضیحات': payment.description
                    }));
                    headers = ['شماره پرداخت', 'کد پرسنلی', 'نام مشتری', 'شماره سند', 'مبلغ پرداختی', 'شماره قسط', 'تاریخ پرداخت', 'ماه', 'سال', 'توضیحات'];
                    filename = 'پرداخت‌ها.csv';
                    break;
                    
                default:
                    return;
            }
            
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(item => {
                const row = headers.map(header => {
                    let value = item[header] || '';
                    
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            showMessage('فایل CSV با موفقیت ایجاد شد و دانلود شروع شد', 'success');
        }
        
        function backupData() {
            const allData = {
                customers: customers,
                debts: debts,
                payments: payments,
                backupDate: new Date().toLocaleString('fa-IR')
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `backup_management_${moment().format('jYYYY-jMM-jDD')}.json`);
            link.click();
            
            showMessage('پشتیبان‌گیری با موفقیت انجام شد', 'success');
        }
        
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (confirm('آیا می‌خواهید داده‌های فعلی با داده‌های پشتیبان جایگزین شوند؟')) {
                            customers = backup.customers || [];
                            debts = backup.debts || [];
                            payments = backup.payments || [];
                            
                            // ریست وضعیت همگام‌سازی بعد از بازیابی
                            sentToSheets.customers.clear();
                            sentToSheets.debts.clear();
                            sentToSheets.payments.clear();
                            
                            saveDataToLocal();
                            saveSyncStatus();
                            
                            loadCustomers();
                            loadDebts();
                            loadPayments();
                            updateDashboardStats();
                            updateSyncStats();
                            
                            showMessage('داده‌ها با موفقیت بازیابی شدند. وضعیت همگام‌سازی ریست شد.', 'success');
                        }
                    } catch (error) {
                        showMessage('خطا در خواندن فایل پشتیبان: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // استایل برای انیمیشن‌ها
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>